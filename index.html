<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice Generator</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 30px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    h2 {
      text-align: center;
      color: #333;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 15px;
    }

    select, input[type="text"], input[type="number"], input[type="date"], textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 5px;
    }

    .line-items {
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 10px;
      text-align: left;
    }

    .btn {
      margin-top: 20px;
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn:hover {
      background-color: #005ea8;
    }

    #loading {
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
      color: #0078d7;
    }

    .section {
      margin-bottom: 30px;
    }

    #successMsg {
      text-align: center;
      font-weight: bold;
      color: green;
      margin-top: 20px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Invoice Generator</h2>
    <p id="loading">Loading vendor & contract data...</p>

    <div class="section">
      <label for="vendor">Vendor:</label>
      <select id="vendor"></select>

      <label for="contract">Contract:</label>
      <select id="contract"></select>

      <label for="invoiceDate">Invoice Date:</label>
      <input type="date" id="invoiceDate">

      <label for="submittedBy">Submitted By:</label>
      <input type="text" id="submittedBy">
    </div>

    <div class="section line-items">
      <label>Line Items:</label>
      <table id="lineItemTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Description</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn" type="button" onclick="addRow()">Add Line Item</button>
    </div>

    <div class="section">
      <label for="totalLabor">Total Labor Amount:</label>
      <input type="number" id="totalLabor" readonly>

      <label for="totalExpense">Total Expense Amount:</label>
      <input type="number" id="totalExpense" readonly>

      <label for="invoiceTotal">Invoice Total:</label>
      <input type="number" id="invoiceTotal" readonly>

      <label>Supplemental Attachments:</label>
      <input type="file" id="supplemental" multiple>
    </div>

    <button class="btn" type="button" onclick="submitForm()">Submit Invoice</button>
    <p id="successMsg">âœ… Invoice submitted successfully!</p>
  </div>

  <script>
    async function loadForm() {
      const loadingMsg = document.getElementById("loading");
      try {
        loadingMsg.innerText = "Loading vendor & contract details...";
        await new Promise(resolve => setTimeout(resolve, 1000));

        const res = await fetch("https://42b858c747f4e3019eb6a3527fd871.58.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/74bef536430e413c953d8e7bbe6108d0/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=sPr1wWfQkacjh8Wo9m1_7GJbMt9iCIvCXHgowvwueck");
        const data = await res.json();

        const vendorDropdown = document.getElementById("vendor");
        vendorDropdown.innerHTML = "";
        data.vendors.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v.title;
          opt.text = v.title;
          vendorDropdown.appendChild(opt);
        });

        const contractDropdown = document.getElementById("contract");
        contractDropdown.innerHTML = "";
        data.contracts.forEach(c => {
          const opt = document.createElement("option");
          opt.value = c.title;
          opt.text = c.title;
          contractDropdown.appendChild(opt);
        });

        loadingMsg.style.display = "none";
      } catch (err) {
        loadingMsg.innerText = "Failed to load data.";
      }
    }

    function addRow() {
      const tbody = document.getElementById("lineItemTable").querySelector("tbody");
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>
          <select class="type" onchange="updateTotals()">
            <option value="Labor">Labor</option>
            <option value="Expense">Expense</option>
          </select>
        </td>
        <td><input type="text" class="desc" placeholder="Description" /></td>
        <td><input type="number" class="qty" placeholder="Qty" onchange="updateTotals()" /></td>
        <td><input type="number" class="unit" placeholder="Unit Price" onchange="updateTotals()" /></td>
        <td class="rowTotal">0.00</td>
      `;
      tbody.appendChild(row);
    }

    function updateTotals() {
      let labor = 0;
      let expense = 0;

      document.querySelectorAll("#lineItemTable tbody tr").forEach(row => {
        const type = row.querySelector(".type").value;
        const qty = parseFloat(row.querySelector(".qty").value || 0);
        const unit = parseFloat(row.querySelector(".unit").value || 0);
        const rowTotal = qty * unit;

        row.querySelector(".rowTotal").innerText = rowTotal.toFixed(2);

        if (type === "Labor") labor += rowTotal;
        else if (type === "Expense") expense += rowTotal;
      });

      document.getElementById("totalLabor").value = labor.toFixed(2);
      document.getElementById("totalExpense").value = expense.toFixed(2);
      document.getElementById("invoiceTotal").value = (labor + expense).toFixed(2);
    }

    function generateInvoiceId() {
      const now = new Date();
      const year = now.getFullYear().toString().slice(-2);
      const month = String(now.getMonth() + 1).padStart(2, "0");
      const rand = Math.floor(Math.random() * 9000) + 1000;
      return `HAPSINV-${year}-${month}-AB-${rand}`;
    }

    async function submitForm() {
      document.getElementById("successMsg").style.display = "none";

      const attachments = [...document.getElementById("supplemental").files];
      const attachmentData = await Promise.all(
        attachments.map(file => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => {
              const base64 = reader.result.split(',')[1];
              resolve({
                name: file.name,
                contentBytes: base64
              });
            };
            reader.readAsDataURL(file);
          });
        })
      );

      let lineItemsHTML = "<table border='1' style='border-collapse:collapse;width:100%'><tr><th>Type</th><th>Description</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr>";
      document.querySelectorAll("#lineItemTable tbody tr").forEach(row => {
        const type = row.querySelector(".type").value;
        const desc = row.querySelector(".desc").value;
        const qty = row.querySelector(".qty").value;
        const unit = row.querySelector(".unit").value;
        const total = row.querySelector(".rowTotal").innerText;
        lineItemsHTML += `<tr><td>${type}</td><td>${desc}</td><td>${qty}</td><td>${unit}</td><td>${total}</td></tr>`;
      });
      lineItemsHTML += "</table>";

      const body = {
        invoiceId: generateInvoiceId(),
        vendor: document.getElementById("vendor").value,
        contract: document.getElementById("contract").value,
        invoiceDate: document.getElementById("invoiceDate").value,
        totalLabor: parseFloat(document.getElementById("totalLabor").value),
        totalExpense: parseFloat(document.getElementById("totalExpense").value),
        invoiceTotal: parseFloat(document.getElementById("invoiceTotal").value),
        submittedBy: document.getElementById("submittedBy").value,
        itemDetails: lineItemsHTML,
        attachments: attachmentData
      };

      const res = await fetch("https://42b858c747f4e3019eb6a3527fd871.58.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/b7aaa3ae05434e909c4f4ff491a06383/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=GLkB21PfHadObFcv6YMM9-NekTNpMbFT1PArzPGJ93E", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        document.getElementById("successMsg").style.display = "block";
        resetForm();
      } else {
        alert("Submission failed. Please try again.");
      }
    }

    function resetForm() {
      document.getElementById("invoiceDate").value = "";
      document.getElementById("submittedBy").value = "";
      document.getElementById("totalLabor").value = "";
      document.getElementById("totalExpense").value = "";
      document.getElementById("invoiceTotal").value = "";
      document.getElementById("supplemental").value = "";
      document.getElementById("lineItemTable").querySelector("tbody").innerHTML = "";
      document.getElementById("vendor").selectedIndex = 0;
      document.getElementById("contract").selectedIndex = 0;
    }

    window.onload = loadForm;
  </script>
</body>
</html>
